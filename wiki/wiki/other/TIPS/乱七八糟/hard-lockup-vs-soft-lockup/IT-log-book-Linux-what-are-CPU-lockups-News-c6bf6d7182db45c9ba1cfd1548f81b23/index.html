<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="IT log book: Linux - what are &ldquo;CPU lockups‚Äù? - News, tips & guidance for agile, development, Atlassian-Software (JIRA, Confluence, Bitbucket, &mldr;) and Google Cloud  https://blog."><title>IT_log_book_Linux_-_what_are_CPU_lockups‚Äù_-_News,__c6bf6d7182db45c9ba1cfd1548f81b23</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://lzyerste.github.io/quartz//icon.png><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Sans+Pro:wght@400;600;700&family=Fira+Code:wght@400;700&display=swap" rel=stylesheet><link href=https://lzyerste.github.io/quartz/styles.48db36360688fe00f0a39f3cf1417c4b.min.css rel=stylesheet><script src=https://lzyerste.github.io/quartz/js/darkmode.46b07878b7f5d9e26ad7a3c40f8a0605.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><script>const BASE_URL="https://lzyerste.github.io/quartz/",fetchData=Promise.all([fetch("https://lzyerste.github.io/quartz/indices/linkIndex.2c8f9d1320a430f1d9c23578617813be.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://lzyerste.github.io/quartz/indices/contentIndex.ff35974cc9ee88c15a1fd6ef77a329aa.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n}))</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://lzyerste.github.io/quartz/js/search.7861a82db330f0a40935b7458fee3a02.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://lzyerste.github.io/quartz/>ü™¥ Quartz 3.2</a></h1><svg tabindex="0" id="search-icon" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg><div class=spacer></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>IT_log_book_Linux_-_what_are_CPU_lockups‚Äù_-_News,__c6bf6d7182db45c9ba1cfd1548f81b23</h1><p class=meta>Last updated Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#short-answer><strong>Short answer</strong></a></li><li><a href=#is-that-bad-has-the-system-crashed><strong>Is that bad? Has the system crashed?</strong></a><ol><li><a href=#generally><strong>Generally</strong></a></li><li><a href=#soft-lockups><strong>Soft lockups</strong></a></li><li><a href=#hard-lockups><strong>Hard lockups</strong></a></li><li><a href=#causes><strong>Causes</strong></a></li></ol></li><li><a href=#what-data-can-be-gathered-in-the-event-of-a-lockup><strong>What data can be gathered in the event of a lockup?</strong></a></li><li><a href=#have-a-bit-of-a-look-around-watchdogs><strong>Have a bit of a look around: Watchdogs</strong></a></li><li><a href=#provoke-lockups-with-your-own-kernel-module><strong>Provoke lockups with your own kernel module</strong></a><ol><li><a href=#soft-lockups-1><strong>Soft lockups</strong></a></li><li><a href=#hard-lockups-1><strong>Hard lockups</strong></a></li></ol></li><li><a href=#further-information><strong>Further information</strong></a></li></ol></nav></details></aside><h1 id=it-log-book-linux---what-are-cpu-lockups---news-tips--guidance-for-agile-development-atlassian-software-jira-confluence-bitbucket--and-google-cloud>IT log book: Linux - what are &ldquo;CPU lockups‚Äù? - News, tips & guidance for agile, development, Atlassian-Software (JIRA, Confluence, Bitbucket, &mldr;) and Google Cloud</h1><p><a href=https://blog.seibert-media.com/2018/01/04/log-book-linux-cpu-lockups/ rel=noopener>https://blog.seibert-media.com/2018/01/04/log-book-linux-cpu-lockups/</a></p><h2 id=short-answer><strong>Short answer</strong></h2><blockquote><p>A ‚Äòsoft lockup‚Äô is defined as a bug that causes the kernel to loop in kernel mode for more than 20 seconds [‚Ä¶], without giving other tasks a chance to run. A ‚Äòhard lockup‚Äô is defined as a bug that causes the CPU to loop in kernel mode for more than 10 seconds [‚Ä¶], without letting other interrupts have a chance to run.</p></blockquote><p>In other words, during a <strong>soft lockup</strong> a kernel task won&rsquo;t unlock the CPU, like in the good old DOS days. So &ldquo;something or other‚Äù is left &ldquo;hanging‚Äù. During a <strong>hard lockup</strong> interrupts aren‚Äôt even being processed, which more clearly points to a bug: something is masking interrupts and not unlocking.</p><h2 id=is-that-bad-has-the-system-crashed><strong>Is that bad? Has the system crashed?</strong></h2><h3 id=generally><strong>Generally</strong></h3><p>We can configure whether a detected lockup will trigger a panic:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sysctl kernel.softlockup_panic kernel.hardlockup_panic
</span></span><span class=line><span class=cl>kernel.softlockup_panic = 0
</span></span><span class=line><span class=cl>kernel.hardlockup_panic = 0
</span></span></code></pre></td></tr></table></div></div><p>But in Ubuntu this appears to be deactivated by default. So initially, the system keeps running and can theoretically right itself again.</p><p>With XenServer, it‚Äôs a different story:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /proc/sys/kernel/softlockup_panic
</span></span><span class=line><span class=cl>1
</span></span></code></pre></td></tr></table></div></div><p>There is no hard lockup watchdog here. This explains why a XenServer host freezes as soon as a soft lockup occurs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[41819967.871466]  EMERG: BUG: soft lockup - CPU#3 stuck for 23s! [tapdisk:23395]
</span></span><span class=line><span class=cl>[41819967.872648]  EMERG: Kernel panic - not syncing: softlockup: hung tasks
</span></span></code></pre></td></tr></table></div></div><h3 id=soft-lockups><strong>Soft lockups</strong></h3><p>With a soft lockup, all you know is that somewhere a kernel task is running and not unlocking a core. Maybe it will keep running. Maybe it won‚Äôt.</p><p>An allegedly typical scenario is this:</p><ul><li>Task 1 locks a resource by way of a spinlock.</li><li>Task 2 also wants to have the spinlock.</li><li>Task 1 doesn‚Äôt unlock it for a rather long time.</li></ul><p>Being a spinlock, task 2 is waiting &ldquo;actively‚Äù, checking over and over again whether it can have its turn yet. This can lead to a soft lockup message. We should be able to recognize this by the RIP in the debug message on the console which is pointing to some function with acquire_spinlock in its name.</p><h3 id=hard-lockups><strong>Hard lockups</strong></h3><p>I haven&rsquo;t yet been able to find any information on this. Once interrupts are no longer being processed, it&rsquo;s presumably quite a bad sign.</p><h3 id=causes><strong>Causes</strong></h3><p>Lockups can never be triggered by processes in the user space as the latter are always reliably scheduled and can be moved aside. If such a lockup occurs, then there has been a problem in the kernel.</p><p>The simplest cause is just bugs. We&rsquo;ll put that aside just now, because it&rsquo;s a boring cause, and we don&rsquo;t have much control over them.</p><p>From here you can probably assume: the kernel code expected that an action would be finished quickly, but that turned out to be wrong. So the kernel needs longer than it thought it would.</p><p>As described by Redhat, it could just be because of a very high system load. But at this point, you need to make a distinction: are you dealing with a &ldquo;real‚Äù system or is it virtual? We have virtualized almost everything. Here VMware talks about
<a href=https://kb.vmware.com/s/article/1009996 rel=noopener>high levels of overcommitment</a> as a possible cause, but it&rsquo;s not entirely clear to me in this context what this refers to ‚Äì presumably the host.</p><p>It&rsquo;s in the nature of the beast that there is no universally valid answer. The watchdogs just detect that certain CPUs are still processing the one task and that the CPU is not being unlocked. That&rsquo;s all. With a bit of luck you can find out why from the stack traces displayed for the hung CPU.</p><h2 id=what-data-can-be-gathered-in-the-event-of-a-lockup><strong>What data can be gathered in the event of a lockup?</strong></h2><p>When there is a lockup, there are several courses of action which can help with your analysis:</p><ul><li>If it is still possible to log in by SSH, gather screenshots from htop, dmesg and Syslog/Journal.</li><li>If you can only see the console with the lockup messages, take screenshots of that.<ul><li>Of interest are output of the process, the row with RIP and the stack trace.</li><li>Wait and see whether the output changes.</li><li>It&rsquo;s not certain that there&rsquo;s definitely <em>just the one</em> lockup ‚Äì multiple CPUs could be affected. At this point, you can still hope that the CPU which originally caused the problem will eventually be reported.</li><li>If it‚Äôs something to do with Java, for example, chances are high that it‚Äôs just a consequential error.</li></ul></li></ul><h2 id=have-a-bit-of-a-look-around-watchdogs><strong>Have a bit of a look around: Watchdogs</strong></h2><p>Take note of the CPU affinity:</p><p>![IT log book Linux - what are CPU lockups‚Äù - News, c6bf6d7182db45c9ba1cfd1548f81b23/gimp-watchdogs1.png](IT log book Linux - what are CPU lockups‚Äù - News, c6bf6d7182db45c9ba1cfd1548f81b23/gimp-watchdogs1.png)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ for pid in 12 15 21 27 33 39 45 51; do taskset -a -p $pid; done
</span></span><span class=line><span class=cl>pid 12&#39;s current affinity mask: 1       # Die Angaben sind hexadezimal.
</span></span><span class=line><span class=cl>pid 15&#39;s current affinity mask: 2
</span></span><span class=line><span class=cl>pid 21&#39;s current affinity mask: 4
</span></span><span class=line><span class=cl>pid 27&#39;s current affinity mask: 8
</span></span><span class=line><span class=cl>pid 33&#39;s current affinity mask: 10
</span></span><span class=line><span class=cl>pid 39&#39;s current affinity mask: 20
</span></span><span class=line><span class=cl>pid 45&#39;s current affinity mask: 40
</span></span><span class=line><span class=cl>pid 51&#39;s current affinity mask: 80
</span></span></code></pre></td></tr></table></div></div><h2 id=provoke-lockups-with-your-own-kernel-module><strong>Provoke lockups with your own kernel module</strong></h2><h3 id=soft-lockups-1><strong>Soft lockups</strong></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># apt install build-essential linux-headers-generic
</span></span></code></pre></td></tr></table></div></div><p><strong>hog.c:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#include &lt;linux/init.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/module.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/kernel.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/kthread.h&gt;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>MODULE_LICENSE(&#34;GPL&#34;);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>static int
</span></span><span class=line><span class=cl>hog_thread(void *data)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    printk(KERN_INFO &#34;Hogging a CPU now\n&#34;);
</span></span><span class=line><span class=cl>    while (1);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    /* unreached */
</span></span><span class=line><span class=cl>    return 0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>static int __init
</span></span><span class=line><span class=cl>hog_init(void)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    kthread_run(hog_thread, NULL, &#34;hog&#34;);
</span></span><span class=line><span class=cl>    return 0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>module_init(hog_init);
</span></span></code></pre></td></tr></table></div></div><p><strong>makefile:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>obj-m += hog.o
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) modules
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) clean
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@ubuntu1604lts:~/thread# make
</span></span><span class=line><span class=cl>make -C /lib/modules/4.4.0-83-generic/build/ M=/root/thread modules
</span></span><span class=line><span class=cl>make[1]: Entering directory &#39;/usr/src/linux-headers-4.4.0-83-generic&#39;
</span></span><span class=line><span class=cl>  CC [M]  /root/thread/hog.o
</span></span><span class=line><span class=cl>  Building modules, stage 2.
</span></span><span class=line><span class=cl>  MODPOST 1 modules
</span></span><span class=line><span class=cl>  LD [M]  /root/thread/hog.ko
</span></span><span class=line><span class=cl>make[1]: Leaving directory &#39;/usr/src/linux-headers-4.4.0-83-generic&#39;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>root@ubuntu1604lts:~/thread# insmod hog.ko
</span></span></code></pre></td></tr></table></div></div><p>And wait. After about 20 seconds the message will appear in the first console and the stack trace will appear in dmesg:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[  355.900698] NMI watchdog: BUG: soft lockup - CPU#0 stuck for 22s! [hog:6885]
</span></span><span class=line><span class=cl>[  355.900735] Modules linked in: hog(OE) ppdev joydev input_leds parport_pc serio_raw parport i2c_piix4 8250_fintek mac_hid ib_iser rdma_cm iw_cm ib_cm ib_sa ib_mad ib_core ib_addr iscsi_tcp libiscsi_tcp libiscsi scsi_transport_iscsi autofs4 btrfs raid10 raid456 async_raid6_recov async_memcpy async_pq async_xor async_tx xor raid6_pq libcrc32c raid1 raid0 multipath linear hid_generic usbhid hid crct10dif_pclmul crc32_pclmul ghash_clmulni_intel aesni_intel aes_x86_64 lrw gf128mul glue_helper ablk_helper cryptd floppy pata_acpi psmouse
</span></span><span class=line><span class=cl>[  355.900761] CPU: 0 PID: 6885 Comm: hog Tainted: G           OEL  4.4.0-83-generic #106-Ubuntu
</span></span><span class=line><span class=cl>[  355.900762] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-20170228_101828-anatol 04/01/2014
</span></span><span class=line><span class=cl>[  355.900764] task: ffff88007bef1c00 ti: ffff88007b7a8000 task.ti: ffff88007b7a8000
</span></span><span class=line><span class=cl>[  355.900765] RIP: 0010:[&lt;ffffffffc0351015&gt;]  [&lt;ffffffffc0351015&gt;] hog_thread+0x15/0x1000 [hog]
</span></span><span class=line><span class=cl>[  355.900769] RSP: 0018:ffff88007b7abeb8  EFLAGS: 00000286
</span></span><span class=line><span class=cl>[  355.900770] RAX: 0000000000000011 RBX: ffff88007b580500 RCX: 0000000000000006
</span></span><span class=line><span class=cl>[  355.900772] RDX: 0000000000000000 RSI: 0000000000000246 RDI: ffff88007fc0dd50
</span></span><span class=line><span class=cl>[  355.900773] RBP: ffff88007b7abeb8 R08: 000000000000000a R09: 000000000000022f
</span></span><span class=line><span class=cl>[  355.900774] R10: ffff880035596a00 R11: 000000000000022f R12: ffff88007bef1c00
</span></span><span class=line><span class=cl>[  355.900775] R13: 0000000000000000 R14: ffffffffc0351000 R15: 0000000000000000
</span></span><span class=line><span class=cl>[  355.900777] FS:  0000000000000000(0000) GS:ffff88007fc00000(0000) knlGS:0000000000000000
</span></span><span class=line><span class=cl>[  355.900778] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
</span></span><span class=line><span class=cl>[  355.900779] CR2: ffffffffc0350fea CR3: 0000000001e0a000 CR4: 00000000001406f0
</span></span><span class=line><span class=cl>[  355.900783] Stack:
</span></span><span class=line><span class=cl>[  355.900784]  ffff88007b7abf48 ffffffff810a0c25 0000000000000000 0000000000000000
</span></span><span class=line><span class=cl>[  355.900786]  0000000000000000 ffff880000000000 ffff880000000000 ffff88007b7abef0
</span></span><span class=line><span class=cl>[  355.900789]  ffff88007b7abef0 ffffffff00000000 ffff880000000000 ffff88007b7abf10
</span></span><span class=line><span class=cl>[  355.900791] Call Trace:
</span></span><span class=line><span class=cl>[  355.900796]  [&lt;ffffffff810a0c25&gt;] kthread+0xe5/0x100
</span></span><span class=line><span class=cl>[  355.900799]  [&lt;ffffffff810a0b40&gt;] ? kthread_create_on_node+0x1e0/0x1e0
</span></span><span class=line><span class=cl>[  355.900802]  [&lt;ffffffff81840f0f&gt;] ret_from_fork+0x3f/0x70
</span></span><span class=line><span class=cl>[  355.900803]  [&lt;ffffffff810a0b40&gt;] ? kthread_create_on_node+0x1e0/0x1e0
</span></span><span class=line><span class=cl>[  355.900804] Code: &lt;eb&gt; fe 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></span></code></pre></td></tr></table></div></div><p>In this example, you can see quite nicely that my hog_thread has been identified as the culprit.</p><p>Here, we need note the following:</p><ul><li>If the system has more than one CPU, it&rsquo;s still usable.</li><li>If you start enough kernel threads to fill all the CPUs to capacity, almost nothing will work. The messages about the soft lockup continue to appear on the console, but you no longer have a hope with SSH.</li></ul><h3 id=hard-lockups-1><strong>Hard lockups</strong></h3><p>Here you need a slight variation of the above code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#include &lt;linux/init.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/module.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/kernel.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/kthread.h&gt;
</span></span><span class=line><span class=cl>#include &lt;linux/spinlock.h&gt;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>MODULE_LICENSE(&#34;GPL&#34;);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>static int
</span></span><span class=line><span class=cl>hog_thread(void *data)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    static DEFINE_SPINLOCK(lock);
</span></span><span class=line><span class=cl>    unsigned long flags;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    printk(KERN_INFO &#34;Hogging a CPU now\n&#34;);
</span></span><span class=line><span class=cl>    spin_lock_irqsave(&amp;lock, flags);
</span></span><span class=line><span class=cl>    while (1);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    /* unreached */
</span></span><span class=line><span class=cl>    return 0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>static int __init
</span></span><span class=line><span class=cl>hog_init(void)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    kthread_run(hog_thread, NULL, &#34;hog&#34;);
</span></span><span class=line><span class=cl>    return 0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>module_init(hog_init);
</span></span></code></pre></td></tr></table></div></div><p>It‚Äôs compiled and used in the exactly same way.</p><p>What do we see? As soon as the module is loaded, nothing works any more. This seems conclusive as, in the case of masked interrupts, (at least to my knowledge) the scheduler can no longer function either.</p><p>After a few seconds, you&rsquo;ll see on the first console a message about a hard lockup. If we test this in a VM virtualized with KVM, we must first activate the NMI watchdog with the following kernel parameter:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>nmi_watchdog=1
</span></span></code></pre></td></tr></table></div></div><h2 id=further-information><strong>Further information</strong></h2><p><a href=https://www.kernel.org/doc/Documentation/lockup-watchdogs.txt rel=noopener>Linux kernel documentation - lockup watchdogs</a>
<a href=http://www.inetservicescloud.com/knowledgebase/what-is-a-cpu-soft-lockup/ rel=noopener>What is a CPU Soft Lockup</a>
<a href=https://lists.kernelnewbies.org/pipermail/kernelnewbies/2012-January/004480.html rel=noopener>Difference between a CPU hard-lockup and a CPU soft-lockup</a>
<a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1009996" rel=noopener>Soft lockup messages from Linux kernel running in an SMP-enabled virtual machine</a>
<a href=http://derekmolloy.ie/writing-a-linux-kernel-module-part-1-introduction/ rel=noopener>Writing a Linux Kernel Module ‚Äî Part 1: Introduction</a>
<a href=https://stackoverflow.com/questions/12974110/simple-kernel-multithreading rel=noopener>Simple kernel multithreading</a>
<a href=https://www.kernel.org/doc/Documentation/locking/spinlocks.txt rel=noopener>Kernel documentation - spinlocks</a></p><p>In the IT logbook, a colleague from our IT team writes about topics, problems and solutions they encounter in their daily work.</p><p><em><a href=https://blog.seibert-media.net/blog/2017/10/05/it-tagebuch-linux-was-sind-cpu-lockups/ rel=noopener>Lesen Sie diese Seite auf Deutsch</a></em></p></article><hr><div class=page-end><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=/>Home</a></li><li><a href=https://twitter.com/_jzhao>Twitter</a></li><li><a href=https://github.com/jackyzha0>Github</a></li></ul></footer></div><script src=https://lzyerste.github.io/quartz/js/popover.e57188d2e4c06b0654e020b3a734bb62.min.js></script>
<script>initPopover("https://lzyerste.github.io/quartz")</script></div></body></html>